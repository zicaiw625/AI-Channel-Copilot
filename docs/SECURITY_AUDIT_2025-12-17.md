# AI Channel Copilot - æ·±åº¦å®‰å…¨å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025-12-17  
**å®¡æŸ¥èŒƒå›´**: å…¨é¢å®¡æŸ¥ï¼ˆå®‰å…¨æ€§ã€åˆè§„æ€§ã€ä»£ç è´¨é‡ã€æ€§èƒ½ã€æµ‹è¯•ã€ä¾èµ–ï¼‰  
**å®¡æŸ¥å‘˜**: AI Assistant

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å¯¹ AI Channel Copilot Shopify åº”ç”¨è¿›è¡Œäº†å…¨é¢æ·±åº¦å®¡æŸ¥ã€‚æ€»ä½“è€Œè¨€ï¼Œè¯¥åº”ç”¨åœ¨å®‰å…¨æ€§å’Œåˆè§„æ€§æ–¹é¢è¡¨ç°è‰¯å¥½ï¼Œä»£ç è´¨é‡è¾ƒé«˜ï¼Œæ¶æ„è®¾è®¡åˆç†ã€‚ä»¥ä¸‹æ˜¯å…³é”®å‘ç°å’Œå»ºè®®ã€‚

### æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | çŠ¶æ€ |
|------|------|------|
| å®‰å…¨æ€§ | A- | è‰¯å¥½ |
| Shopify åˆè§„æ€§ | A | ä¼˜ç§€ |
| ä»£ç è´¨é‡ | A- | è‰¯å¥½ |
| æ€§èƒ½ä¼˜åŒ– | B+ | è¾ƒå¥½ |
| æµ‹è¯•è¦†ç›– | B | åˆæ ¼ |
| ä¾èµ–å®‰å…¨ | A- | è‰¯å¥½ |

---

## ä¸€ã€å®‰å…¨æ€§å®¡æŸ¥

### 1.1 è®¤è¯ä¸æˆæƒ âœ… é€šè¿‡

**ä¼˜ç‚¹:**
- ä½¿ç”¨ Shopify SDK çš„ `authenticate.admin()` å’Œ `authenticate.webhook()` è¿›è¡Œç»Ÿä¸€è®¤è¯
- Session ç®¡ç†ä½¿ç”¨ `PrismaSessionStorage`ï¼Œå®‰å…¨å¯é 
- ç”Ÿäº§ç¯å¢ƒæ­£ç¡®ç¦ç”¨äº†æ‰‹åŠ¨ç™»å½•é¡µé¢ï¼ˆ`/auth/login`ï¼‰
- æƒé™æ§åˆ¶é€šè¿‡ `access.server.ts` å®ç°ï¼ŒåŸºäºè®¢é˜…çŠ¶æ€çš„åŠŸèƒ½é—¨æ§

**ä»£ç ç¤ºä¾‹:**

```15:19:app/routes/auth.login/route.tsx
const rejectInProduction = () => {
  if (isProduction()) {
    throw new Response("Not Found", { status: 404 });
  }
};
```

**å»ºè®®:**
- (LOW) è€ƒè™‘åœ¨ `getEffectivePlan` ä¸­æ·»åŠ ç¼“å­˜ï¼Œå‡å°‘é‡å¤çš„æ•°æ®åº“æŸ¥è¯¢

### 1.2 Webhook å®‰å…¨ âœ… é€šè¿‡

**ä¼˜ç‚¹:**
- æ‰€æœ‰ Webhook è·¯ç”±ä½¿ç”¨ `authenticate.webhook()` è¿›è¡Œ HMAC éªŒè¯
- å®ç°äº† `X-Shopify-Webhook-Id` å»é‡æœºåˆ¶é˜²æ­¢é‡æ”¾æ”»å‡»
- åˆç†çš„é”™è¯¯å¤„ç†ï¼šå¯æ¢å¤é”™è¯¯è¿”å› 500ï¼ˆè§¦å‘é‡è¯•ï¼‰ï¼Œä¸å¯æ¢å¤é”™è¯¯è¿”å› 200ï¼ˆé¿å…é‡è¯•é£æš´ï¼‰

**ä»£ç ç¤ºä¾‹:**

```139:155:app/lib/orderWebhooks.server.ts
// æ—©æœŸå»é‡æ£€æŸ¥ï¼šåœ¨å…¥é˜Ÿå‰æ£€æŸ¥ X-Shopify-Webhook-Idï¼ˆShopify æœ€ä½³å®è·µï¼‰
const externalId = request.headers.get("X-Shopify-Webhook-Id") || ...
if (externalId) {
  const isDuplicate = await checkWebhookDuplicate(shop, topic, externalId);
  if (isDuplicate) {
    return new Response("Duplicate", { status: 200 });
  }
}
```

### 1.3 æ•°æ®å®‰å…¨ âœ… é€šè¿‡

**ä¼˜ç‚¹:**
- å®Œå–„çš„è¾“å…¥éªŒè¯ï¼šä½¿ç”¨ Zod schema éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- æ•æ„Ÿæ•°æ®è„±æ•ï¼š`sanitizer.ts` å®ç°äº† PII å’Œæ•æ„Ÿå­—æ®µçš„è‡ªåŠ¨è„±æ•
- æ—¥å¿—å®‰å…¨ï¼š`logger.server.ts` å¯¹æ•æ„Ÿå­—æ®µè¿›è¡Œäº†ç™½åå•/é»‘åå•è¿‡æ»¤
- é€Ÿç‡é™åˆ¶ï¼šå®ç°äº†å¤šçº§åˆ«çš„é€Ÿç‡é™åˆ¶ï¼ˆAPIã€Webhookã€Copilotã€å¯¼å‡ºç­‰ï¼‰

**å‘ç°çš„é—®é¢˜:**

| çº§åˆ« | é—®é¢˜ | ä½ç½® | å»ºè®® |
|------|------|------|------|
| LOW | é€Ÿç‡é™åˆ¶ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œå¤šå®ä¾‹éƒ¨ç½²æ—¶æ— æ•ˆ | `rateLimit.server.ts` | ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµ |

---

## äºŒã€Shopify App Store åˆè§„æ€§

### 2.1 å¿…éœ€ Webhook å¤„ç† âœ… å®Œå…¨å®ç°

| Webhook | æ–‡ä»¶ | çŠ¶æ€ |
|---------|------|------|
| `app/uninstalled` | `webhooks.app.uninstalled.tsx` | âœ… å·²å®ç° |
| `customers/data_request` | `webhooks.customers.data_request.tsx` | âœ… å·²å®ç° |
| `customers/redact` | `webhooks.customers.redact.tsx` | âœ… å·²å®ç° |
| `shop/redact` | `webhooks.shop.redact.tsx` | âœ… å·²å®ç° |

**GDPR åˆè§„äº®ç‚¹:**
- `gdpr.server.ts` æä¾›å®Œæ•´çš„æ•°æ®æ”¶é›†ã€åˆ é™¤åŠŸèƒ½
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®åˆ é™¤çš„åŸå­æ€§
- æ¸…ç† WebhookJob ä¸­å¯èƒ½åŒ…å« PII çš„ payload

### 2.2 æƒé™æœ€å°åŒ– âœ… é€šè¿‡

**å½“å‰æƒé™é…ç½®:**
```toml
scopes = "read_orders,read_customers,read_products,write_orders,read_checkouts,read_content,read_themes"
```

**æƒé™ä½¿ç”¨éªŒè¯:**

| æƒé™ | ç”¨é€” | å¿…è¦æ€§ |
|------|------|--------|
| `read_orders` | AI å½’å› åˆ†ææ ¸å¿ƒåŠŸèƒ½ | âœ… å¿…éœ€ |
| `read_customers` | LTV/å¤è´­ç‡åˆ†æ | âœ… å¿…éœ€ |
| `read_products` | äº§å“ä¼˜åŒ–å»ºè®® | âœ… å¿…éœ€ |
| `read_checkouts` | æ¼æ–—è½¬åŒ–åˆ†æ | âœ… å¿…éœ€ |
| `write_orders` | è®¢å•æ ‡ç­¾å†™å›ï¼ˆç”¨æˆ·å¯æ§ï¼‰ | âš ï¸ å¯é€‰ |
| `read_content` | llms.txt åšå®¢è·å– | âš ï¸ å¯é€‰ |
| `read_themes` | App Embed çŠ¶æ€æ£€æµ‹ | âš ï¸ å¯é€‰ |

**å»ºè®®:**
- å·²æ­£ç¡®ç§»é™¤ `write_customers`ï¼Œç¬¦åˆæœ€å°æƒé™åŸåˆ™
- æ–‡æ¡£å®Œå–„ï¼ˆ`docs/PERMISSIONS.md`ï¼‰

### 2.3 è®¡è´¹æµç¨‹ âœ… é€šè¿‡

**ä¼˜ç‚¹:**
- å®Œæ•´çš„è®¡è´¹çŠ¶æ€æœºï¼š`NO_PLAN` â†’ `TRIALING` â†’ `ACTIVE` / `EXPIRED`
- è¯•ç”¨æœŸè¿½è¸ªï¼šå‡†ç¡®è®¡ç®—å‰©ä½™å¤©æ•°ï¼Œæ”¯æŒå¸è½½åé‡è£…ç»§ç»­è¯•ç”¨
- å¼€å‘åº—æ£€æµ‹ï¼šæ­£ç¡®è¯†åˆ« `partnerDevelopment` åº—é“º
- è®¢é˜…åŒæ­¥ï¼šæ”¯æŒä» Shopify Billing API åŒæ­¥è®¢é˜…çŠ¶æ€

---

## ä¸‰ã€ä»£ç è´¨é‡

### 3.1 æ¶æ„è®¾è®¡ âœ… è‰¯å¥½

**åˆ†å±‚æ¶æ„:**
```
Routes (è·¯ç”±å±‚)
  â†“
Services (ä¸šåŠ¡é€»è¾‘å±‚)
  â†“
Repositories (æ•°æ®è®¿é—®å±‚)
  â†“
Prisma (ORM)
```

**ä¼˜ç‚¹:**
- æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- ç»Ÿä¸€çš„é”™è¯¯ç±»å‹å®šä¹‰ (`errors.ts`)
- å®Œå–„çš„ Prisma é”™è¯¯å¤„ç† (`prismaErrors.ts`)

### 3.2 æ—¥å¿—ä¸å¯è§‚æµ‹æ€§ âœ… è‰¯å¥½

**ä¼˜ç‚¹:**
- ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨è„±æ•
- GraphQL è°ƒç”¨ç›‘æ§ (`observability.server.ts`)

### 3.3 TypeScript ç±»å‹å®‰å…¨ âœ… è‰¯å¥½

**ä¼˜ç‚¹:**
- ä½¿ç”¨ Zod å®ç°è¿è¡Œæ—¶ç±»å‹éªŒè¯
- GraphQL ç±»å‹ç”Ÿæˆ
- å®Œå–„çš„ç±»å‹å¯¼å‡º

---

## å››ã€æ€§èƒ½ä¼˜åŒ–

### 4.1 æ•°æ®åº“æ€§èƒ½ âœ… è¾ƒå¥½

**Prisma Schema ç´¢å¼•è®¾è®¡è‰¯å¥½:**

```prisma
@@index([shopDomain, createdAt])
@@index([shopDomain, aiSource, createdAt(sort: Desc)])
@@index([shopDomain, totalSpent(sort: Desc)])
```

**å‘ç°çš„é—®é¢˜:**

| çº§åˆ« | é—®é¢˜ | å»ºè®® |
|------|------|------|
| MEDIUM | éƒ¨åˆ†æŸ¥è¯¢å¯èƒ½å­˜åœ¨ N+1 é—®é¢˜ | ä½¿ç”¨ `include` é¢„åŠ è½½å…³è”æ•°æ® |
| LOW | ç¼ºå°‘æŸ¥è¯¢æ€§èƒ½ç›‘æ§ | `databaseOptimization.ts` å·²æä¾›å·¥å…·ä½†æœªå¹¿æ³›ä½¿ç”¨ |

### 4.2 ç¼“å­˜ç­–ç•¥ âœ… å·²å®ç°

**ç¼“å­˜å®ä¾‹:**
- `settingsCache`: 10 åˆ†é’Ÿ TTL
- `dashboardCache`: 5 åˆ†é’Ÿ TTL
- `customerCache`: 15 åˆ†é’Ÿ TTL

### 4.3 GraphQL ä¼˜åŒ– âœ… è‰¯å¥½

**ä¼˜ç‚¹:**
- å®ç°äº†æŸ¥è¯¢é™çº§æœºåˆ¶ï¼ˆfull â†’ fallback â†’ minimalï¼‰
- è‡ªåŠ¨å¤„ç† Protected Customer Data æƒé™é—®é¢˜
- é‡è¯•æœºåˆ¶å¸¦æŒ‡æ•°é€€é¿

---

## äº”ã€æµ‹è¯•è¦†ç›–

### 5.1 ç°æœ‰æµ‹è¯•åˆ†æ

**æµ‹è¯•æ–‡ä»¶:**
- `aiAttribution.test.ts` - AI å½’å› æ£€æµ‹ âœ… è¦†ç›–è‰¯å¥½
- `billing.server.test.ts` - è®¡è´¹æµç¨‹ âœ… åŸºç¡€è¦†ç›–
- `gdprRoutes.test.ts` - GDPR Webhook âœ… å·²è¦†ç›–
- `pipeline.integration.test.ts` - é›†æˆæµ‹è¯• âœ… å·²è¦†ç›–

**è¦†ç›–ç‡è¯„ä¼°:**

| æ¨¡å— | è¦†ç›–çŠ¶æ€ | å»ºè®® |
|------|----------|------|
| AI å½’å› é€»è¾‘ | è‰¯å¥½ | - |
| è®¡è´¹çŠ¶æ€æœº | åŸºç¡€ | å¢åŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯• |
| Webhook å¤„ç† | éƒ¨åˆ† | å¢åŠ é”™è¯¯åœºæ™¯æµ‹è¯• |
| æ•°æ®æŒä¹…åŒ– | ç¼ºå¤± | éœ€è¦æ·»åŠ  |
| å®‰å…¨æ¨¡å— | ç¼ºå¤± | éœ€è¦æ·»åŠ  |

### 5.2 æµ‹è¯•ç¼ºå£

| ä¼˜å…ˆçº§ | ç¼ºå¤±çš„æµ‹è¯• |
|--------|-----------|
| HIGH | `persistence.server.ts` æ•°æ®æŒä¹…åŒ–æµ‹è¯• |
| HIGH | `webhookQueue.server.ts` é˜Ÿåˆ—å¤„ç†æµ‹è¯• |
| MEDIUM | `security/rateLimit.server.ts` é™æµæµ‹è¯• |
| MEDIUM | `security/sanitizer.ts` è„±æ•æµ‹è¯• |
| LOW | ç«¯åˆ°ç«¯é›†æˆæµ‹è¯• |

---

## å…­ã€ä¾èµ–å®‰å…¨

### 6.1 npm audit ç»“æœ

```
æ¼æ´æ€»æ•°: 5 (å…¨éƒ¨ä¸º moderate çº§åˆ«)
å—å½±å“åŒ…: vitest â†’ vite â†’ esbuild
```

**è¯¦æƒ…:**
- `esbuild` (<=0.24.2): å¼€å‘æœåŠ¡å™¨ CORS é—®é¢˜ (GHSA-67mh-4wv8-2f99)
- **å½±å“èŒƒå›´**: ä»…å½±å“å¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§éƒ¨ç½²ä¸å—å½±å“

**å»ºè®®:**
- ç­‰å¾… vitest æ›´æ–°åå‡çº§
- æ­¤æ¼æ´ä»…åœ¨å¼€å‘ç¯å¢ƒå­˜åœ¨ï¼Œé£é™©å¯æ§

### 6.2 ä¾èµ–ç‰ˆæœ¬çŠ¶æ€

```
æ‰€æœ‰ä¾èµ–å‡ä¸ºæœ€æ–°ç‰ˆæœ¬ âœ…
```

---

## ä¸ƒã€æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§æ’åº

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (å»ºè®®åœ¨ä¸‹ä¸ªç‰ˆæœ¬ä¿®å¤)

1. **å¢åŠ å…³é”®æ¨¡å—æµ‹è¯•è¦†ç›–**
   - ä¸º `persistence.server.ts` æ·»åŠ å•å…ƒæµ‹è¯•
   - ä¸º `webhookQueue.server.ts` æ·»åŠ é˜Ÿåˆ—å¤„ç†æµ‹è¯•

2. **æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•**
   - è¦†ç›–æ ¸å¿ƒç”¨æˆ·æµç¨‹ï¼šå®‰è£… â†’ é…ç½® â†’ æ•°æ®å¯¼å…¥ â†’ åˆ†æ

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (å»ºè®®åœ¨åç»­è¿­ä»£ä¸­å¤„ç†)

3. **åˆ†å¸ƒå¼é™æµ**
   - å°†å†…å­˜é™æµå‡çº§ä¸º Redis å®ç°ï¼ˆå¦‚æœè®¡åˆ’å¤šå®ä¾‹éƒ¨ç½²ï¼‰

4. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
   - å®¡æŸ¥é«˜é¢‘æŸ¥è¯¢ï¼Œæ·»åŠ å¿…è¦çš„ `include` é¢„åŠ è½½
   - å¯ç”¨ Prisma æŸ¥è¯¢æ—¥å¿—ç›‘æ§æ…¢æŸ¥è¯¢

5. **å¢åŠ å®‰å…¨æ¨¡å—æµ‹è¯•**
   - `sanitizer.ts` è„±æ•é€»è¾‘æµ‹è¯•
   - `rateLimit.server.ts` é™æµé€»è¾‘æµ‹è¯•

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ (å»ºè®®åœ¨æœ‰ç©ºé—²æ—¶å¤„ç†)

6. **ç¼“å­˜ä¼˜åŒ–**
   - åœ¨ `getEffectivePlan` ä¸­æ·»åŠ ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢

7. **ä»£ç ä¼˜åŒ–**
   - åˆå¹¶éƒ¨åˆ†é‡å¤çš„ Webhook å¤„ç†é€»è¾‘
   - æå–å…¬å…±çš„ GraphQL é”™è¯¯å¤„ç†åˆ°å·¥å…·å‡½æ•°

---

## å…«ã€åˆè§„æ€§æ£€æŸ¥æ¸…å•

### Shopify App Store å®¡æ ¸è¦æ±‚

| è¦æ±‚ | çŠ¶æ€ |
|------|------|
| æ”¯æŒåµŒå…¥å¼å®‰è£… | âœ… |
| å¤„ç† `app/uninstalled` Webhook | âœ… |
| å®ç° GDPR Webhook (3ä¸ª) | âœ… |
| ç¦æ­¢æ‰‹åŠ¨è¾“å…¥åº—é“ºåŸŸå | âœ… |
| HTTPS å¼ºåˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ | âœ… |
| æƒé™æœ€å°åŒ– | âœ… |
| è®¡è´¹æµç¨‹æ­£ç¡® | âœ… |

### GDPR/CCPA åˆè§„

| è¦æ±‚ | çŠ¶æ€ |
|------|------|
| å®¢æˆ·æ•°æ®è¯·æ±‚å¤„ç† | âœ… |
| å®¢æˆ·æ•°æ®åˆ é™¤ | âœ… |
| åº—é“ºæ•°æ®åˆ é™¤ | âœ… |
| PII æœ€å°åŒ–æ”¶é›† | âœ… |
| æ•°æ®ä¿ç•™ç­–ç•¥ | âœ… (å¯é…ç½® retentionMonths) |

---

## ä¹ã€ç»“è®º

AI Channel Copilot æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½ã€å®‰å…¨æ€§è¾ƒé«˜çš„ Shopify åº”ç”¨ã€‚ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š

1. **å®‰å…¨æ€§**: å®Œå–„çš„è®¤è¯ã€Webhook éªŒè¯ã€è¾“å…¥éªŒè¯å’Œæ•æ„Ÿæ•°æ®å¤„ç†
2. **åˆè§„æ€§**: å®Œå…¨ç¬¦åˆ Shopify App Store å’Œ GDPR è¦æ±‚
3. **ä»£ç è´¨é‡**: æ¸…æ™°çš„æ¶æ„ã€è‰¯å¥½çš„é”™è¯¯å¤„ç†ã€å®Œå–„çš„ç±»å‹å®šä¹‰

ä¸»è¦æ”¹è¿›æ–¹å‘ï¼š

1. å¢åŠ æµ‹è¯•è¦†ç›–ç‡ï¼Œç‰¹åˆ«æ˜¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œå®‰å…¨æ¨¡å—
2. å¦‚æœè®¡åˆ’å¤šå®ä¾‹éƒ¨ç½²ï¼Œå‡çº§é™æµä¸ºåˆ†å¸ƒå¼å®ç°
3. æŒç»­ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Œä¼˜åŒ–é«˜é¢‘æŸ¥è¯¢

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-17  
**ä¸‹æ¬¡å»ºè®®å®¡æŸ¥æ—¶é—´**: 2026-03-17 (å­£åº¦å®¡æŸ¥)
