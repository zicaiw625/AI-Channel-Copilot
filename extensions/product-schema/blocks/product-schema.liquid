{% comment %}
  AI Channel Copilot - Product Schema Markup
  自动为产品页面添加 JSON-LD 结构化数据，提升产品在 AI 助手中的可发现性
  
  功能：
  - 自动检测产品页面并注入 Schema
  - 支持多图片、品牌、价格、库存状态
  - 兼容所有 Shopify 主题
  
  商家只需在 Theme settings → App embeds 中开启即可
{% endcomment %}

{% if request.page_type == 'product' %}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
    assign product_price = current_variant.price | money_without_currency | remove: ','
    assign compare_price = current_variant.compare_at_price | money_without_currency | remove: ','
  %}
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": {{ product.title | json }},
    "description": {{ product.description | strip_html | truncate: 5000 | json }},
    "url": "{{ shop.url }}{{ product.url }}",
    {% if product.images.size > 0 %}
    "image": [
      {% for image in product.images limit: 10 %}
        "{{ image | image_url: width: 1200 }}"{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    {% endif %}
    {% if current_variant.sku != blank %}
    "sku": {{ current_variant.sku | json }},
    {% endif %}
    {% if product.id %}
    "productID": "{{ product.id }}",
    {% endif %}
    {% if current_variant.barcode != blank %}
    "gtin": {{ current_variant.barcode | json }},
    {% endif %}
    {% if product.vendor != blank %}
    "brand": {
      "@type": "Brand",
      "name": {{ product.vendor | json }}
    },
    {% endif %}
    {% if product.type != blank %}
    "category": {{ product.type | json }},
    {% endif %}
    "offers": {
      "@type": "Offer",
      "url": "{{ shop.url }}{{ product.url }}",
      "price": "{{ product_price }}",
      "priceCurrency": "{{ shop.currency }}",
      "availability": "{% if current_variant.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
      "itemCondition": "https://schema.org/NewCondition",
      {% if compare_price != blank and compare_price != product_price %}
      "priceValidUntil": "{{ 'now' | date: '%Y' | plus: 1 }}-12-31",
      {% endif %}
      "seller": {
        "@type": "Organization",
        "name": {{ shop.name | json }}
      }
    }
    {% comment %} 如果有多个变体，添加 AggregateOffer {% endcomment %}
    {% if product.variants.size > 1 %}
    ,"offers": {
      "@type": "AggregateOffer",
      "lowPrice": "{{ product.price_min | money_without_currency | remove: ',' }}",
      "highPrice": "{{ product.price_max | money_without_currency | remove: ',' }}",
      "priceCurrency": "{{ shop.currency }}",
      "offerCount": "{{ product.variants.size }}",
      "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
    }
    {% endif %}
  }
  </script>
{% endif %}

{% schema %}
{
  "name": "t:blocks.product_schema.name",
  "target": "head",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": []
}
{% endschema %}
