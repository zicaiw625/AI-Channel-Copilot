// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

enum AiSource {
  ChatGPT
  Perplexity
  Gemini
  Copilot
  Other_AI
}

model Customer {
  id               String   @id
  shopDomain       String
  acquiredViaAi    Boolean  @default(false)
  firstOrderAt     DateTime?
  lastOrderAt      DateTime?
  orderCount       Int      @default(0)
  totalSpent       Float    @default(0)
  firstAiOrderId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           Order[]

  @@index([shopDomain])
}

model Order {
  id              String    @id
  shopDomain      String
  name            String
  createdAt       DateTime
  totalPrice      Float
  subtotalPrice   Float?
  aiSource        AiSource?
  detection       String?
  referrer        String?
  landingPage     String?
  utmSource       String?
  utmMedium       String?
  sourceName      String?
  customerId      String?
  isNewCustomer   Boolean   @default(false)
  products        OrderProduct[]
  createdAtLocal  DateTime?
  updatedAt       DateTime  @updatedAt

  customer        Customer? @relation(fields: [customerId], references: [id])

  @@index([shopDomain, createdAt])
  @@index([shopDomain, aiSource])
}

model OrderProduct {
  id         Int     @id @default(autoincrement())
  orderId    String
  productId  String
  title      String
  handle     String?
  url        String?
  price      Float
  quantity   Int

  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

model ShopSettings {
  id                 Int      @id @default(autoincrement())
  shopDomain         String   @unique
  primaryCurrency    String   @default("USD")
  aiDomains          Json
  utmSources         Json
  utmMediumKeywords  Json
  orderTagPrefix     String
  customerTag        String
  writeOrderTags     Boolean  @default(false)
  writeCustomerTags  Boolean  @default(false)
  taggingDryRun      Boolean  @default(true)
  language           String   @default("中文")
  timezone           String   @default("UTC")
  gmvMetric          String   @default("current_total_price")
  pipelineStatuses   Json?
  lastOrdersWebhookAt DateTime?
  lastBackfillAt     DateTime?
  lastTaggingAt      DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
