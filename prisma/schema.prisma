// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

enum AiSource {
  ChatGPT
  Perplexity
  Gemini
  Copilot
  Other_AI
}

enum JobStatus {
  queued
  processing
  completed
  failed
}

model Customer {
  id               String   @id
  shopDomain       String
  platform         String   @default("shopify")
  acquiredViaAi    Boolean  @default(false)
  firstOrderId     String?
  firstOrderAt     DateTime?
  lastOrderAt      DateTime?
  orderCount       Int      @default(0)
  totalSpent       Float    @default(0)
  firstAiOrderId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           Order[]

  @@index([shopDomain])
  @@index([shopDomain, platform])
}

model Order {
  id              String    @id
  shopDomain      String
  platform        String    @default("shopify")
  name            String
  createdAt       DateTime
  totalPrice      Float
  currency        String   @default("USD")
  subtotalPrice   Float?
  refundTotal     Float    @default(0)
  aiSource        AiSource?
  detection       String?
  detectionSignals Json?
  referrer        String?
  landingPage     String?
  utmSource       String?
  utmMedium       String?
  sourceName      String?
  customerId      String?
  isNewCustomer   Boolean   @default(false)
  products        OrderProduct[]
  createdAtLocal  DateTime?
  updatedAt       DateTime  @updatedAt

  customer        Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([shopDomain, createdAt])
  @@index([shopDomain, platform, createdAt])
  @@index([shopDomain, aiSource])
  @@index([shopDomain, platform])
  @@index([shopDomain, createdAt(sort: Desc)], map: "orders_shop_date_desc")
  @@index([shopDomain, aiSource, createdAt(sort: Desc)], map: "orders_shop_ai_desc")
  @@index([aiSource, id], map: "orders_ai_id")
}

model OrderProduct {
  id         Int     @id @default(autoincrement())
  orderId    String
  productId  String
  title      String
  handle     String?
  url        String?
  price      Float
  currency   String   @default("USD")
  quantity   Int

  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

model ShopSettings {
  id                    Int      @id @default(autoincrement())
  shopDomain            String
  platform              String   @default("shopify")
  primaryCurrency       String   @default("USD")
  aiDomains             Json
  utmSources            Json
  utmMediumKeywords     Json
  orderTagPrefix        String
  customerTag           String
  writeOrderTags        Boolean  @default(false)
  writeCustomerTags     Boolean  @default(false)
  taggingDryRun         Boolean  @default(true)
  language              String   @default("中文")
  timezone              String   @default("UTC")
  gmvMetric             String   @default("current_total_price")
  pipelineStatuses      Json?
  aiExposurePreferences Json?
  llmsTxtCache          String?  @db.Text
  llmsTxtCachedAt       DateTime?
  retentionMonths       Int      @default(6)
  lastOrdersWebhookAt   DateTime?
  lastCleanupAt         DateTime?
  lastBackfillAt        DateTime?
  lastTaggingAt         DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([shopDomain, platform])
  @@unique([shopDomain, platform], map: "shopDomain_platform")
}

model WebhookJob {
  id         Int        @id @default(autoincrement())
  shopDomain String
  topic      String
  intent     String
  payload    Json
  externalId String?
  orderId    String?
  eventTime  DateTime?
  attempts   Int        @default(0)
  nextRunAt  DateTime?
  status     JobStatus  @default(queued)
  error      String?
  createdAt  DateTime   @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([shopDomain])
  @@index([status])
  @@unique([shopDomain, topic, externalId], map: "webhook_unique_external")
  @@index([shopDomain, topic, orderId])
  @@index([status, nextRunAt])
}

model BackfillJob {
  id            Int        @id @default(autoincrement())
  shopDomain    String
  range         String
  rangeStart    DateTime   @default(now())
  rangeEnd      DateTime   @default(now())
  maxOrders     Int?
  maxDurationMs Int?
  status        JobStatus  @default(queued)
  ordersFetched Int        @default(0)
  error         String?
  createdAt     DateTime   @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?

  @@index([shopDomain])
  @@index([status])
}

model ShopBillingState {
  id                     Int       @id @default(autoincrement())
  shopDomain             String
  platform               String    @default("shopify")
  isDevShop              Boolean   @default(false)
  
  // Billing State Machine Fields
  billingPlan            String    @default("NO_PLAN") // free, pro, growth, NO_PLAN
  billingState           String    @default("NO_PLAN") // NO_PLAN, FREE_ACTIVE, PRO_TRIALING, PRO_ACTIVE, etc.
  
  // Trial Tracking
  firstInstalledAt       DateTime? // For calculating total trial eligibility
  lastTrialStartAt       DateTime?
  lastTrialEndAt         DateTime?
  usedTrialDays          Int       @default(0)
  
  // Subscription History
  hasEverSubscribed      Boolean   @default(false)
  lastSubscriptionStatus String?   // Raw Shopify status
  lastCheckedAt          DateTime?
  lastUninstalledAt      DateTime?
  lastReinstalledAt      DateTime?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([shopDomain])
  @@unique([shopDomain, platform], map: "billing_shop_platform")
}

// ============================================================================
// 漏斗归因扩展：Session, Checkout, FunnelEvent
// ============================================================================

model VisitorSession {
  id               String    @id
  shopDomain       String
  platform         String    @default("shopify")
  
  // 访问信息
  visitorId        String?
  customerId       String?
  startedAt        DateTime
  landingPage      String?
  referrer         String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  
  // AI 归因
  aiSource         AiSource?
  detectionSignals Json?
  
  // 漏斗状态
  hasAddToCart       Boolean  @default(false)
  hasCheckoutStarted Boolean  @default(false)
  hasOrderCompleted  Boolean  @default(false)
  
  // 关联
  checkoutId       String?
  orderId          String?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([shopDomain])
  @@index([shopDomain, platform])
  @@index([shopDomain, startedAt])
  @@index([aiSource])
  @@index([customerId])
}

model Checkout {
  id              String    @id
  shopDomain      String
  platform        String    @default("shopify")
  
  // Shopify checkout 信息
  token           String?
  cartToken       String?
  email           String?
  customerId      String?
  
  // 时间节点
  createdAt       DateTime
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  abandonedAt     DateTime?
  
  // 金额
  totalPrice      Float     @default(0)
  subtotalPrice   Float?
  currency        String    @default("USD")
  
  // 归因信息
  referrer        String?
  landingPage     String?
  utmSource       String?
  utmMedium       String?
  aiSource        AiSource?
  detectionSignals Json?
  
  // 状态: open, completed, abandoned
  status          String    @default("open")
  
  // 关联
  orderId         String?
  lineItemsCount  Int       @default(0)

  @@index([shopDomain])
  @@index([shopDomain, platform])
  @@index([shopDomain, createdAt])
  @@index([aiSource])
  @@index([status])
  @@index([customerId])
  // 用于 markAbandonedCheckouts 查询优化
  @@index([shopDomain, status, abandonedAt, createdAt], map: "checkout_abandonment_query")
  // 用于按 aiSource 和 status 聚合
  @@index([shopDomain, aiSource, status], map: "checkout_ai_status")
}

model FunnelEvent {
  id            Int       @id @default(autoincrement())
  shopDomain    String
  platform      String    @default("shopify")
  
  // 事件类型: page_view, add_to_cart, checkout_started, checkout_completed, order_created
  eventType     String
  eventTime     DateTime
  
  // 关联 ID
  sessionId     String?
  checkoutId    String?
  orderId       String?
  customerId    String?
  productId     String?
  
  // 归因
  aiSource      AiSource?
  referrer      String?
  utmSource     String?
  
  // 元数据
  metadata      Json?
  
  createdAt     DateTime  @default(now())

  @@index([shopDomain])
  @@index([shopDomain, eventType])
  @@index([shopDomain, eventTime])
  @@index([aiSource])
  @@index([sessionId])
  @@index([checkoutId])
}
