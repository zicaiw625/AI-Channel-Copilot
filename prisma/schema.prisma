// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
  @@index([email])
}

enum AiSource {
  ChatGPT
  Perplexity
  Gemini
  Copilot
  Other_AI
}

enum JobStatus {
  queued
  processing
  completed
  failed
}

model Customer {
  id               String   @id
  shopDomain       String
  platform         String   @default("shopify")
  acquiredViaAi    Boolean  @default(false)
  firstOrderId     String?
  firstOrderAt     DateTime?
  lastOrderAt      DateTime?
  orderCount       Int      @default(0)
  totalSpent       Decimal  @default(0) @db.Decimal(12, 2)
  firstAiOrderId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           Order[]

  @@index([shopDomain])
  @@index([shopDomain, platform])
  // LTV æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼ˆTop Customer æ’åºï¼‰
  @@index([shopDomain, totalSpent(sort: Desc)], map: "customer_shop_ltv_desc")
  // AI å®¢æˆ·ç­›é€‰ç´¢å¼•
  @@index([shopDomain, acquiredViaAi], map: "customer_shop_ai")
  // æ•°æ®æ¸…ç†ä¼˜åŒ–ç´¢å¼•
  @@index([shopDomain, updatedAt], map: "customer_shop_updated")
}

model Order {
  id              String    @id
  shopDomain      String
  platform        String    @default("shopify")
  name            String
  createdAt       DateTime
  totalPrice      Decimal   @db.Decimal(12, 2)
  currency        String   @default("USD")
  subtotalPrice   Decimal?  @db.Decimal(12, 2)
  refundTotal     Decimal   @default(0) @db.Decimal(12, 2)
  aiSource        AiSource?
  detection       String?
  detectionSignals Json?
  referrer        String?
  landingPage     String?
  utmSource       String?
  utmMedium       String?
  sourceName      String?
  customerId      String?
  isNewCustomer   Boolean   @default(false)
  products        OrderProduct[]
  createdAtLocal  DateTime?
  updatedAt       DateTime  @updatedAt

  customer        Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([shopDomain, createdAt])
  @@index([shopDomain, platform, createdAt])
  @@index([shopDomain, aiSource])
  @@index([shopDomain, platform])
  @@index([shopDomain, createdAt(sort: Desc)], map: "orders_shop_date_desc")
  @@index([shopDomain, aiSource, createdAt(sort: Desc)], map: "orders_shop_ai_desc")
  @@index([aiSource, id], map: "orders_ai_id")
}

model OrderProduct {
  id         Int     @id @default(autoincrement())
  orderId    String
  productId  String
  lineItemId String  // ğŸ”§ æ–°å¢ï¼šShopify è¡Œé¡¹ç›® IDï¼Œç”¨äºå”¯ä¸€æ ‡è¯†åŒä¸€è®¢å•ä¸­çš„ä¸åŒ variant
  title      String
  handle     String?
  url        String?
  price      Decimal  @db.Decimal(12, 2)
  currency   String   @default("USD")
  quantity   Int

  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  // ğŸ”§ æ–°å¢ï¼šå”¯ä¸€çº¦æŸï¼Œç¡®ä¿åŒä¸€è®¢å•çš„åŒä¸€è¡Œé¡¹ç›®ä¸ä¼šé‡å¤
  @@unique([orderId, lineItemId], map: "order_line_item_unique")
}

model ShopSettings {
  id                    Int      @id @default(autoincrement())
  shopDomain            String
  platform              String   @default("shopify")
  primaryCurrency       String   @default("USD")
  aiDomains             Json
  utmSources            Json
  utmMediumKeywords     Json
  orderTagPrefix        String
  customerTag           String
  writeOrderTags        Boolean  @default(false)
  writeCustomerTags     Boolean  @default(false)
  taggingDryRun         Boolean  @default(true)
  language              String   @default("ä¸­æ–‡")
  timezone              String   @default("UTC")
  gmvMetric             String   @default("current_total_price")
  pipelineStatuses      Json?
  aiExposurePreferences Json?
  llmsTxtCache          String?  @db.Text
  llmsTxtCachedAt       DateTime?
  retentionMonths       Int      @default(6)
  lastOrdersWebhookAt   DateTime?
  lastCleanupAt         DateTime?
  lastBackfillAt        DateTime?  // æœ€åä¸€æ¬¡æ‹‰åˆ°è®¢å•çš„æ—¶é—´
  lastBackfillAttemptAt DateTime?  // æœ€åä¸€æ¬¡ backfill å°è¯•å®Œæˆçš„æ—¶é—´ï¼ˆæ— è®ºæ˜¯å¦æœ‰è®¢å•ï¼‰
  lastBackfillOrdersFetched Int?   // æœ€åä¸€æ¬¡ backfill æ‹‰å–åˆ°çš„è®¢å•æ•°
  lastTaggingAt         DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([shopDomain, platform])
  @@unique([shopDomain, platform], map: "shopDomain_platform")
}

model WebhookJob {
  id         Int        @id @default(autoincrement())
  shopDomain String
  topic      String
  intent     String
  payload    Json
  externalId String?
  orderId    String?
  eventTime  DateTime?
  attempts   Int        @default(0)
  nextRunAt  DateTime?
  status     JobStatus  @default(queued)
  error      String?
  createdAt  DateTime   @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([shopDomain])
  @@index([status])
  @@unique([shopDomain, topic, externalId], map: "webhook_unique_external")
  @@index([shopDomain, topic, orderId])
  @@index([status, nextRunAt])
}

model BackfillJob {
  id            Int        @id @default(autoincrement())
  shopDomain    String
  range         String
  rangeStart    DateTime   @default(now())
  rangeEnd      DateTime   @default(now())
  maxOrders     Int?
  maxDurationMs Int?
  status        JobStatus  @default(queued)
  ordersFetched Int        @default(0)
  error         String?
  createdAt     DateTime   @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?

  @@index([shopDomain])
  @@index([status])
}

model ShopBillingState {
  id                     Int       @id @default(autoincrement())
  shopDomain             String
  platform               String    @default("shopify")
  isDevShop              Boolean   @default(false)
  
  // Billing State Machine Fields
  billingPlan            String    @default("NO_PLAN") // free, pro, growth, NO_PLAN
  billingState           String    @default("NO_PLAN") // NO_PLAN, FREE_ACTIVE, PRO_TRIALING, PRO_ACTIVE, etc.
  
  // Trial Tracking
  firstInstalledAt       DateTime? // For calculating total trial eligibility
  lastTrialStartAt       DateTime?
  lastTrialEndAt         DateTime?
  usedTrialDays          Int       @default(0)
  
  // Subscription History
  hasEverSubscribed      Boolean   @default(false)
  lastSubscriptionStatus String?   // Raw Shopify status
  lastCheckedAt          DateTime?
  lastUninstalledAt      DateTime?
  lastReinstalledAt      DateTime?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([shopDomain])
  @@unique([shopDomain, platform], map: "billing_shop_platform")
}

// ============================================================================
// æ¼æ–—å½’å› æ‰©å±•ï¼šSession, Checkout, FunnelEvent
// ============================================================================

model VisitorSession {
  id               String    @id
  shopDomain       String
  platform         String    @default("shopify")
  
  // è®¿é—®ä¿¡æ¯
  visitorId        String?
  customerId       String?
  startedAt        DateTime
  landingPage      String?
  referrer         String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  
  // AI å½’å› 
  aiSource         AiSource?
  detectionSignals Json?
  
  // æ¼æ–—çŠ¶æ€
  hasAddToCart       Boolean  @default(false)
  hasCheckoutStarted Boolean  @default(false)
  hasOrderCompleted  Boolean  @default(false)
  
  // å…³è”
  checkoutId       String?
  orderId          String?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([shopDomain])
  @@index([shopDomain, platform])
  @@index([shopDomain, startedAt])
  @@index([aiSource])
  @@index([customerId])
}

model Checkout {
  id              String    @id
  shopDomain      String
  platform        String    @default("shopify")
  
  // Shopify checkout ä¿¡æ¯
  token           String?
  cartToken       String?
  hasEmail        Boolean   @default(false)  // ä»…æ ‡è®°æ˜¯å¦æœ‰é‚®ç®±ï¼Œä¸å­˜å‚¨å®é™… PII
  customerId      String?
  
  // æ—¶é—´èŠ‚ç‚¹
  createdAt       DateTime
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  abandonedAt     DateTime?
  
  // é‡‘é¢
  totalPrice      Decimal   @default(0) @db.Decimal(12, 2)
  subtotalPrice   Decimal?  @db.Decimal(12, 2)
  currency        String    @default("USD")
  
  // å½’å› ä¿¡æ¯
  referrer        String?
  landingPage     String?
  utmSource       String?
  utmMedium       String?
  aiSource        AiSource?
  detectionSignals Json?
  
  // çŠ¶æ€: open, completed, abandoned
  status          String    @default("open")
  
  // å…³è”
  orderId         String?
  lineItemsCount  Int       @default(0)

  @@index([shopDomain])
  @@index([shopDomain, platform])
  @@index([shopDomain, createdAt])
  @@index([aiSource])
  @@index([status])
  @@index([customerId])
  // ç”¨äº markAbandonedCheckouts æŸ¥è¯¢ä¼˜åŒ–
  @@index([shopDomain, status, abandonedAt, createdAt], map: "checkout_abandonment_query")
  // ç”¨äºæŒ‰ aiSource å’Œ status èšåˆ
  @@index([shopDomain, aiSource, status], map: "checkout_ai_status")
}

model FunnelEvent {
  id            Int       @id @default(autoincrement())
  shopDomain    String
  platform      String    @default("shopify")
  
  // äº‹ä»¶ç±»å‹: page_view, add_to_cart, checkout_started, checkout_completed, order_created
  eventType     String
  eventTime     DateTime
  
  // å…³è” ID
  sessionId     String?
  checkoutId    String?
  orderId       String?
  customerId    String?
  productId     String?
  
  // å½’å› 
  aiSource      AiSource?
  referrer      String?
  utmSource     String?
  
  // å…ƒæ•°æ®
  metadata      Json?
  
  createdAt     DateTime  @default(now())

  @@index([shopDomain])
  @@index([shopDomain, eventType])
  @@index([shopDomain, eventTime])
  @@index([aiSource])
  @@index([sessionId])
  @@index([checkoutId])
}
